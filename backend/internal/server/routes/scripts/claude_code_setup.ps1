#Requires -Version 5.1
<#
.SYNOPSIS
    Claude Code Setup Script
.DESCRIPTION
    One-click configuration script for Claude Code
    Claude Code 一键配置脚本
    此脚本由服务端动态生成，已包含配置信息
.PARAMETER ApiKey
    Your API Key
.PARAMETER SkipCleanup
    Skip conflict cleanup
.PARAMETER Force
    Force cleanup without confirmation
.PARAMETER Language
    Language selection: zh (Chinese) or en (English)
.EXAMPLE
    irm https://your-server.com/scripts/claude-code-setup.ps1 | iex
.EXAMPLE
    .\claude-code-setup.ps1 -ApiKey "sk-xxx"
#>

param(
    [string]$ApiKey,
    [switch]$SkipCleanup,
    [switch]$Force,
    [ValidateSet("zh", "en")]
    [string]$Language = "zh"
)

# ============================================================
# Server Configuration (Generated by server)
# 服务端配置（由服务端动态生成）
# ============================================================
$SITE_NAME = "{{SITE_NAME}}"
$API_BASE_URL = "{{API_BASE_URL}}"
$SERVER_URL = "{{SERVER_URL}}"

# ============================================================
# Language strings
# ============================================================

$MSG_ZH = @{
    "info" = "信息"
    "success" = "成功"
    "warning" = "警告"
    "error" = "错误"
    "select_lang" = "请选择语言 / Select language"
    "lang_zh" = "中文"
    "lang_en" = "English"
    "enter_choice" = "请输入选择 (默认: 1)"
    "title" = "Claude Code 配置脚本 for $SITE_NAME"
    "api_base_url" = "API Base URL"
    "api_key_prompt" = "请输入您的 API Key"
    "api_key_hint" = "请先在 $SITE_NAME Web 界面获取 API Key"
    "api_key_empty" = "API Key 不能为空"
    "env_check_title" = "环境冲突检测"
    "checking_env" = "检测环境变量..."
    "checking_claude" = "检测 Claude 配置文件..."
    "checking_profile" = "检测 PowerShell Profile..."
    "found_env" = "发现环境变量"
    "found_file" = "发现配置文件"
    "contains_anthropic" = "包含 ANTHROPIC 配置"
    "no_conflicts" = "未发现环境冲突"
    "conflicts_found" = "发现潜在冲突配置"
    "cleanup_prompt" = "是否清理冲突配置？(Y/n)"
    "cleanup_title" = "清理冲突配置"
    "backup_dir" = "备份目录"
    "backed_up" = "已备份"
    "cleaned" = "已清理"
    "cleanup_done" = "清理完成"
    "skip_cleanup" = "跳过清理，可能导致配置冲突"
    "config_title" = "配置 Claude Code"
    "created_config" = "已创建 Claude 配置"
    "set_env" = "已设置用户环境变量"
    "verify_title" = "验证配置"
    "testing_api" = "测试 API 连接..."
    "api_test_pass" = "API 连接测试通过"
    "api_test_warn" = "API 连接测试返回"
    "api_test_hint" = "这可能是网络问题或服务器暂时不可用"
    "verifying_files" = "验证配置文件..."
    "config_verified" = "Claude 配置文件已正确设置"
    "config_missing" = "Claude 配置文件缺少 ANTHROPIC_BASE_URL"
    "config_not_exist" = "Claude 配置文件不存在"
    "complete_title" = "配置完成"
    "current_config" = "当前配置"
    "config_active" = "配置已在当前会话生效"
    "next_steps" = "下一步操作"
    "step1" = "重新打开终端或 VS Code"
    "step2" = "运行 'claude' 命令开始使用"
    "help_hint" = "如遇问题，请访问"
}

$MSG_EN = @{
    "info" = "INFO"
    "success" = "SUCCESS"
    "warning" = "WARNING"
    "error" = "ERROR"
    "select_lang" = "Select language / 请选择语言"
    "lang_zh" = "中文"
    "lang_en" = "English"
    "enter_choice" = "Enter your choice (default: 1)"
    "title" = "Claude Code Setup Script for $SITE_NAME"
    "api_base_url" = "API Base URL"
    "api_key_prompt" = "Enter your API Key"
    "api_key_hint" = "Please get your API Key from $SITE_NAME web interface first"
    "api_key_empty" = "API Key cannot be empty"
    "env_check_title" = "Environment Conflict Check"
    "checking_env" = "Checking environment variables..."
    "checking_claude" = "Checking Claude configuration files..."
    "checking_profile" = "Checking PowerShell Profile..."
    "found_env" = "Found environment variable"
    "found_file" = "Found configuration file"
    "contains_anthropic" = "contains ANTHROPIC config"
    "no_conflicts" = "No environment conflicts found"
    "conflicts_found" = "Potential conflicts found"
    "cleanup_prompt" = "Clean up conflicting configurations? (Y/n)"
    "cleanup_title" = "Cleaning Up Conflicts"
    "backup_dir" = "Backup directory"
    "backed_up" = "Backed up"
    "cleaned" = "Cleaned"
    "cleanup_done" = "Cleanup complete"
    "skip_cleanup" = "Skipping cleanup, may cause configuration conflicts"
    "config_title" = "Configuring Claude Code"
    "created_config" = "Created Claude configuration"
    "set_env" = "Set user environment variables"
    "verify_title" = "Verifying Configuration"
    "testing_api" = "Testing API connection..."
    "api_test_pass" = "API connection test passed"
    "api_test_warn" = "API connection test returned"
    "api_test_hint" = "This may be a network issue or server temporarily unavailable"
    "verifying_files" = "Verifying configuration files..."
    "config_verified" = "Claude configuration file correctly set"
    "config_missing" = "Claude configuration file missing ANTHROPIC_BASE_URL"
    "config_not_exist" = "Claude configuration file does not exist"
    "complete_title" = "Configuration Complete"
    "current_config" = "Current Configuration"
    "config_active" = "Configuration is now active in current session"
    "next_steps" = "Next Steps"
    "step1" = "Reopen terminal or VS Code"
    "step2" = "Run 'claude' command to start using"
    "help_hint" = "For issues, please visit"
}

$script:Messages = $MSG_ZH

function Get-Msg {
    param([string]$Key)
    return $script:Messages[$Key]
}

# ============================================================
# Output functions
# ============================================================

function Write-Info {
    param([string]$Message)
    Write-Host "[$((Get-Msg 'info'))] $Message" -ForegroundColor Cyan
}

function Write-Success {
    param([string]$Message)
    Write-Host "[$((Get-Msg 'success'))] $Message" -ForegroundColor Green
}

function Write-Warn {
    param([string]$Message)
    Write-Host "[$((Get-Msg 'warning'))] $Message" -ForegroundColor Yellow
}

function Write-Err {
    param([string]$Message)
    Write-Host "[$((Get-Msg 'error'))] $Message" -ForegroundColor Red
}

function Write-Section {
    param([string]$Title)
    Write-Host ""
    Write-Host "=============================================" -ForegroundColor Blue
    Write-Host "  $Title" -ForegroundColor Blue
    Write-Host "=============================================" -ForegroundColor Blue
    Write-Host ""
}

# ============================================================
# Language selection
# ============================================================

function Select-Language {
    Write-Host ""
    Write-Host (Get-Msg 'select_lang') -ForegroundColor White
    Write-Host "  1) $((Get-Msg 'lang_zh'))"
    Write-Host "  2) $((Get-Msg 'lang_en'))"
    Write-Host ""
    $choice = Read-Host (Get-Msg 'enter_choice')

    if ($choice -eq "2") {
        $script:Messages = $MSG_EN
        $script:Language = "en"
    } else {
        $script:Messages = $MSG_ZH
        $script:Language = "zh"
    }
}

# ============================================================
# Banner
# ============================================================

function Show-Banner {
    Write-Host ""
    Write-Host "=============================================" -ForegroundColor Cyan
    Write-Host "  $((Get-Msg 'title'))" -ForegroundColor Cyan
    Write-Host "=============================================" -ForegroundColor Cyan
    Write-Host ""
}

# ============================================================
# Environment conflict check
# ============================================================

function Test-EnvironmentConflicts {
    $conflicts = @()

    Write-Section (Get-Msg 'env_check_title')

    # Check user environment variables
    Write-Info (Get-Msg 'checking_env')

    $envVars = @("ANTHROPIC_BASE_URL", "ANTHROPIC_AUTH_TOKEN", "ANTHROPIC_API_KEY")
    foreach ($var in $envVars) {
        $userValue = [Environment]::GetEnvironmentVariable($var, "User")
        if ($userValue) {
            $conflicts += @{Type="UserEnv"; Name=$var; Value=$userValue}
            Write-Warn "$((Get-Msg 'found_env')) (User): $var"
        }

        $machineValue = [Environment]::GetEnvironmentVariable($var, "Machine")
        if ($machineValue) {
            $conflicts += @{Type="MachineEnv"; Name=$var; Value=$machineValue}
            Write-Warn "$((Get-Msg 'found_env')) (System): $var"
        }
    }

    # Check Claude settings.json
    Write-Info (Get-Msg 'checking_claude')

    $claudeConfig = Join-Path $env:USERPROFILE ".claude\settings.json"
    if (Test-Path $claudeConfig) {
        $content = Get-Content $claudeConfig -Raw -ErrorAction SilentlyContinue
        if ($content -match "ANTHROPIC") {
            $conflicts += @{Type="File"; Name=$claudeConfig}
            Write-Warn "$((Get-Msg 'found_file')): $claudeConfig $((Get-Msg 'contains_anthropic'))"
        }
    }

    # Check PowerShell Profile
    Write-Info (Get-Msg 'checking_profile')

    if (Test-Path $PROFILE) {
        $profileContent = Get-Content $PROFILE -Raw -ErrorAction SilentlyContinue
        if ($profileContent -match "ANTHROPIC") {
            $conflicts += @{Type="File"; Name=$PROFILE}
            Write-Warn "$((Get-Msg 'found_file')): $PROFILE $((Get-Msg 'contains_anthropic'))"
        }
    }

    Write-Host ""

    if ($conflicts.Count -gt 0) {
        Write-Warn "$((Get-Msg 'conflicts_found')): $($conflicts.Count)"
        return $conflicts
    } else {
        Write-Success (Get-Msg 'no_conflicts')
        return @()
    }
}

# ============================================================
# Cleanup conflicts
# ============================================================

function Clear-Conflicts {
    param([array]$Conflicts)

    $backupDir = Join-Path $env:USERPROFILE ".claude-code-backup-$(Get-Date -Format 'yyyyMMddHHmmss')"
    New-Item -ItemType Directory -Path $backupDir -Force | Out-Null

    Write-Section (Get-Msg 'cleanup_title')
    Write-Info "$((Get-Msg 'backup_dir')): $backupDir"

    foreach ($conflict in $Conflicts) {
        switch ($conflict.Type) {
            "UserEnv" {
                # Backup to file
                "$($conflict.Name)=$($conflict.Value)" | Out-File (Join-Path $backupDir "user_env.txt") -Append -Encoding UTF8
                [Environment]::SetEnvironmentVariable($conflict.Name, $null, "User")
                Write-Success "$((Get-Msg 'cleaned')): $($conflict.Name) (User)"
            }
            "File" {
                $fileName = Split-Path $conflict.Name -Leaf
                Copy-Item $conflict.Name (Join-Path $backupDir $fileName) -Force
                Write-Info "$((Get-Msg 'backed_up')): $($conflict.Name)"
            }
        }
    }

    Write-Host ""
    Write-Success "$((Get-Msg 'cleanup_done')), $((Get-Msg 'backup_dir')): $backupDir"
}

# ============================================================
# Setup Claude Code configuration
# ============================================================

function Set-ClaudeCodeConfig {
    param(
        [string]$ConfigApiKey
    )

    Write-Section (Get-Msg 'config_title')

    # Create .claude directory
    $claudeDir = Join-Path $env:USERPROFILE ".claude"
    if (-not (Test-Path $claudeDir)) {
        New-Item -ItemType Directory -Path $claudeDir -Force | Out-Null
    }

    # Create or update settings.json
    $claudeConfig = Join-Path $claudeDir "settings.json"

    $settings = @{
        env = @{
            ANTHROPIC_BASE_URL = $API_BASE_URL
            ANTHROPIC_AUTH_TOKEN = $ConfigApiKey
            CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC = "1"
        }
    }

    # Try to merge with existing config
    if (Test-Path $claudeConfig) {
        try {
            $existing = Get-Content $claudeConfig -Raw | ConvertFrom-Json -AsHashtable -ErrorAction Stop
            if ($null -eq $existing.env) {
                $existing.env = @{}
            }
            foreach ($key in $settings.env.Keys) {
                $existing.env[$key] = $settings.env[$key]
            }
            $settings = $existing
        } catch {
            # Parse failed, use new config
        }
    }

    $settings | ConvertTo-Json -Depth 10 | Set-Content $claudeConfig -Encoding UTF8
    Write-Success "$((Get-Msg 'created_config')): $claudeConfig"

    # Set user environment variables
    [Environment]::SetEnvironmentVariable("ANTHROPIC_BASE_URL", $API_BASE_URL, "User")
    [Environment]::SetEnvironmentVariable("ANTHROPIC_AUTH_TOKEN", $ConfigApiKey, "User")
    [Environment]::SetEnvironmentVariable("CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC", "1", "User")
    Write-Success (Get-Msg 'set_env')

    # Set environment variables for current session
    $env:ANTHROPIC_BASE_URL = $API_BASE_URL
    $env:ANTHROPIC_AUTH_TOKEN = $ConfigApiKey
    $env:CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC = "1"
}

# ============================================================
# Verify setup
# ============================================================

function Test-Setup {
    param(
        [string]$TestApiKey
    )

    Write-Section (Get-Msg 'verify_title')

    # Test API connection
    Write-Info (Get-Msg 'testing_api')

    $testUrl = "$API_BASE_URL/v1/models"

    try {
        $response = Invoke-WebRequest -Uri $testUrl -Headers @{
            "x-api-key" = $TestApiKey
            "anthropic-version" = "2023-06-01"
        } -TimeoutSec 30 -UseBasicParsing -ErrorAction Stop

        Write-Success "$((Get-Msg 'api_test_pass')) (HTTP $($response.StatusCode))"
    } catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        if ($statusCode -ge 400 -and $statusCode -lt 500) {
            Write-Warn "$((Get-Msg 'api_test_warn')): HTTP $statusCode"
        } else {
            Write-Warn "$((Get-Msg 'api_test_warn')): $($_.Exception.Message)"
        }
        Write-Info (Get-Msg 'api_test_hint')
    }

    # Verify config file
    Write-Info (Get-Msg 'verifying_files')

    $claudeConfig = Join-Path $env:USERPROFILE ".claude\settings.json"
    if (Test-Path $claudeConfig) {
        $content = Get-Content $claudeConfig -Raw
        if ($content -match "ANTHROPIC_BASE_URL") {
            Write-Success (Get-Msg 'config_verified')
            return $true
        } else {
            Write-Err (Get-Msg 'config_missing')
            return $false
        }
    } else {
        Write-Err "$((Get-Msg 'config_not_exist')): $claudeConfig"
        return $false
    }
}

# ============================================================
# Show completion message
# ============================================================

function Show-Completion {
    param([string]$CompletionApiKey)

    Write-Host ""
    Write-Host "=============================================" -ForegroundColor Green
    Write-Host "  $((Get-Msg 'complete_title'))" -ForegroundColor Green
    Write-Host "=============================================" -ForegroundColor Green
    Write-Host ""

    # Show current configuration
    Write-Host "$((Get-Msg 'current_config')):" -ForegroundColor White
    Write-Host "  ANTHROPIC_BASE_URL: " -NoNewline -ForegroundColor Gray
    Write-Host $API_BASE_URL -ForegroundColor Cyan
    $maskedKey = $CompletionApiKey.Substring(0, [Math]::Min(20, $CompletionApiKey.Length)) + "..."
    Write-Host "  ANTHROPIC_AUTH_TOKEN: " -NoNewline -ForegroundColor Gray
    Write-Host $maskedKey -ForegroundColor Cyan
    Write-Host ""

    Write-Success (Get-Msg 'config_active')
    Write-Host ""

    Write-Host "$((Get-Msg 'next_steps')):" -ForegroundColor White
    Write-Host "  1. $((Get-Msg 'step1'))"
    Write-Host "  2. $((Get-Msg 'step2'))"
    Write-Host ""
    Write-Host "$((Get-Msg 'help_hint')): $SERVER_URL"
    Write-Host ""
}

# ============================================================
# Main
# ============================================================

function Main {
    # Set language if specified
    if ($Language -eq "en") {
        $script:Messages = $MSG_EN
    }

    # Show banner and select language
    Show-Banner

    if (-not $ApiKey) {
        Select-Language
        Show-Banner
    }

    # Show server info
    Write-Success "$((Get-Msg 'api_base_url')): $API_BASE_URL"

    # Get API Key
    if (-not $ApiKey) {
        Write-Host ""
        Write-Info (Get-Msg 'api_key_hint')
        Write-Info "Login: $SERVER_URL -> API Keys -> Create Key"
        Write-Host ""
        $secureKey = Read-Host (Get-Msg 'api_key_prompt') -AsSecureString
        $ApiKey = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
            [Runtime.InteropServices.Marshal]::SecureStringToBSTR($secureKey)
        )
    }

    if (-not $ApiKey) {
        Write-Err (Get-Msg 'api_key_empty')
        exit 1
    }

    # Environment conflict check
    $conflicts = Test-EnvironmentConflicts
    if ($conflicts.Count -gt 0 -and -not $SkipCleanup) {
        Write-Host ""
        $response = "y"
        if (-not $Force) {
            $response = Read-Host (Get-Msg 'cleanup_prompt')
        }
        if ($response -ne "n" -and $response -ne "N") {
            Clear-Conflicts -Conflicts $conflicts
        } else {
            Write-Warn (Get-Msg 'skip_cleanup')
        }
    }

    # Setup configuration
    Set-ClaudeCodeConfig -ConfigApiKey $ApiKey

    # Verify setup
    if (Test-Setup -TestApiKey $ApiKey) {
        Show-Completion -CompletionApiKey $ApiKey
    } else {
        Write-Err "Configuration verification failed"
        exit 1
    }
}

# Run main
Main
